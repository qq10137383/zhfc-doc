# 介绍

## 什么是微前端

传统的 `vue` 前端项目，每个项目都有独立的登录、菜单、权限管理等功能，需要整合到一起存在困难，微前端产生的目的就是为了解决系统之间耦合问题，使应用之间彼此独立的同时又能方便的整合到一起。

微前端分为主项目(基座)和子项目(应用系统)，对于一个微前端项目往往会有一个主项目和多个子项目。  
- **主项目**：负责统一登录、菜单、权限拦截、子系统加载、系统通信等功能。
- **子项目**：负责应用系统具体功能。

子项目虽然可以独立运行，但是缺少登录权限功能也是不能正常使用的，所以子项目一般都是嵌入主项目中运行，下图描述了主项目和子项目的关系。
    
![关系图](/images/guide/relationship.jpg)

## 微前端的特点

微前端架构具备以下几个核心价值：

- 技术栈无关  
  主项目不限制接入应用的技术栈，子项目具备完全自主权，子项目可以是基于路由系统的技术栈，例如：`vue2` 、`vue3`、`react`、`angular` 等。

- 独立开发、独立部署  
  子项目仓库独立，可独立开发、独立部署，部署完成后主项目自动完成同步更新。

- 独立运行  
  每个子项目之间状态隔离，运行时状态不共享。

- 统一入口  
  主项目统一负责系统的登录、菜单、权限拦截等功能，子项目只负责实现具体的业务功能，子项目通过 `事件` 和 `api` 与主项目、其他子项目之间交互。

## 它是如何工作的？

智慧房产微前端是基于 [vue2](https://v2.cn.vuejs.org/) 和 [qiankun](https://qiankun.umijs.org/zh) 的微前端脚手架。

### 子系统加载

对路由的监听是微前端实现的关键，当切换路由地址满足子系统路由激活规则时，**qiankun** 加载对应子系统代码，渲染到指定的区域。

- 如有两个子系统 `白蚁防治` 和 `安全监督`，激活规则如下：

| 激活规则 | 子系统     |
| -------- | ---------- |
| `/byfz`  | `白蚁防治` |
| `/aqjd`  | `安全监督` |

- 两个系统各有两个路由，路由规则如下：

1. `白蚁防治`：

| 路由                       | 功能项             |
| -------------------------- | ------------------ |
| `/entrustDisposeInfo`      | `委托受理信息`     |
| `/projectConstructionInfo` | `防治工程施工信息` |

2. `安全监督`：

| 路由                    | 功能项             |
| ----------------------- | ------------------ |
| `/safetyAssessmentInfo` | `安全监督业务受理` |
| `/reportSendRegister`   | `报告发放登记`     |

- 按照 `激活规则` 和 `路由规则`，输入路由地址时加载子系统和功能如下：

| 路由地址                        | 加载子系统 | 加载功能项         |
| ------------------------------- | ---------- | ------------------ |
| `/byfz/entrustDisposeInfo`      | `白蚁防治` | `委托受理信息`     |
| `/byfz/projectConstructionInfo` | `白蚁防治` | `防治工程施工信息` |
| `/aqjd/safetyAssessmentInfo`    | `安全监督` | `安全监督业务受理` |
| `/aqjd/reportSendRegister`      | `安全监督` | `报告发放登记`     |

主项目加载子系统，在蓝色区域渲染子系统功能。

![路由加载子系统](/images/guide/load.jpg)

::: tip
qiankun 底层使用 [single-spa](https://single-spa.js.org/) 加载子系统代码，加载完成后会调用子系统 [生命周期钩子函数](https://qiankun.umijs.org/zh/guide/getting-started#1-%E5%AF%BC%E5%87%BA%E7%9B%B8%E5%BA%94%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90)，
在 `mount` 方法中渲染子系统到主项目指定的 `dom` ，在 `unmount` 方法中完成子系统的卸载。
:::

### 隔离沙箱

多个子系统嵌入到主项目中加载时，可能会存在同时修改 `window` 等全局对象，增加事件监听 `addEventListener` 等操作，以及相同的样式规则会添加到主项目(如：`element-ui` 样式)，当子系统卸载时需要清理这些副作用，否则会造成全局对象的污染以及样式污染，`qiankun` 提供了隔离沙箱来解决这些问题。

1. **Proxy沙箱**

**qiankun** 使用 `ES6 Proxy` 生成 `FakeWindow` 对象劫持了 `window` 对象的修改， 当应用卸载时会还原 `window` 对象到初始状态。

2. **样式隔离**

**qiankun** 提供了多种样式隔离方案。

- 当开启严格样式隔离 [strictStyleIsolation](https://qiankun.umijs.org/zh/api#startopts) 时会在主项目中生成
一个 [shadow dom](https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_shadow_DOM) 来挂载子系统，子系统的样式天然就是隔离的。
- 当默认开启沙盒模式时，**qiankun** 会遍历子系统的样式增加样式前缀，这样子系统样式就具有更高的优先级会覆盖其他系统样式，如 **白蚁防治** 子系统 `el-radio-button`
  
``` css
div[data-qiankun-byfz] .el-radio-button {
  position: relative;
  display: inline-block;
  outline: 0;
}
```

